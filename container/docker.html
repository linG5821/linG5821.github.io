<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Docker安装 | Yolo Cloud</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="Yolo Cloud 记录了我技术成长中学到的各种知识,遇到的各种问题">
    
    <link rel="preload" href="/assets/css/0.styles.ef76fb7a.css" as="style"><link rel="preload" href="/assets/js/app.8b02bca0.js" as="script"><link rel="preload" href="/assets/js/2.f0a5ede2.js" as="script"><link rel="preload" href="/assets/js/1.b1f9bc46.js" as="script"><link rel="preload" href="/assets/js/26.2fbe0a85.js" as="script"><link rel="prefetch" href="/assets/js/10.e34437a3.js"><link rel="prefetch" href="/assets/js/11.2ac4c563.js"><link rel="prefetch" href="/assets/js/12.8811f863.js"><link rel="prefetch" href="/assets/js/13.e33c9f1a.js"><link rel="prefetch" href="/assets/js/14.d189864d.js"><link rel="prefetch" href="/assets/js/15.b8cbc93b.js"><link rel="prefetch" href="/assets/js/16.f81e8873.js"><link rel="prefetch" href="/assets/js/17.8ce53420.js"><link rel="prefetch" href="/assets/js/18.eb4ada07.js"><link rel="prefetch" href="/assets/js/19.543cb74c.js"><link rel="prefetch" href="/assets/js/20.71d66c7d.js"><link rel="prefetch" href="/assets/js/21.ff4ddfa8.js"><link rel="prefetch" href="/assets/js/22.3524a129.js"><link rel="prefetch" href="/assets/js/23.e0411f18.js"><link rel="prefetch" href="/assets/js/24.11853f02.js"><link rel="prefetch" href="/assets/js/25.40f139e1.js"><link rel="prefetch" href="/assets/js/27.446e1e33.js"><link rel="prefetch" href="/assets/js/28.32892409.js"><link rel="prefetch" href="/assets/js/29.5a2b13bb.js"><link rel="prefetch" href="/assets/js/3.c8520702.js"><link rel="prefetch" href="/assets/js/30.a38e59fa.js"><link rel="prefetch" href="/assets/js/31.a50a8381.js"><link rel="prefetch" href="/assets/js/32.c6847094.js"><link rel="prefetch" href="/assets/js/33.0c49d146.js"><link rel="prefetch" href="/assets/js/34.f9e23d8d.js"><link rel="prefetch" href="/assets/js/35.74cf6739.js"><link rel="prefetch" href="/assets/js/36.71be65e7.js"><link rel="prefetch" href="/assets/js/37.a8f50a47.js"><link rel="prefetch" href="/assets/js/38.60bda7ec.js"><link rel="prefetch" href="/assets/js/39.e81b415f.js"><link rel="prefetch" href="/assets/js/4.c5e770fe.js"><link rel="prefetch" href="/assets/js/40.159dc556.js"><link rel="prefetch" href="/assets/js/41.796f71f2.js"><link rel="prefetch" href="/assets/js/42.25ea701b.js"><link rel="prefetch" href="/assets/js/43.9dff9f08.js"><link rel="prefetch" href="/assets/js/44.cf6a7133.js"><link rel="prefetch" href="/assets/js/45.229ca46d.js"><link rel="prefetch" href="/assets/js/46.8626bfdd.js"><link rel="prefetch" href="/assets/js/47.3385f5ec.js"><link rel="prefetch" href="/assets/js/48.a30573be.js"><link rel="prefetch" href="/assets/js/49.146fdfee.js"><link rel="prefetch" href="/assets/js/5.417f2406.js"><link rel="prefetch" href="/assets/js/50.bedffd55.js"><link rel="prefetch" href="/assets/js/51.fc75e8af.js"><link rel="prefetch" href="/assets/js/52.eda4be03.js"><link rel="prefetch" href="/assets/js/53.248db3e5.js"><link rel="prefetch" href="/assets/js/54.02136a92.js"><link rel="prefetch" href="/assets/js/55.aa10dd82.js"><link rel="prefetch" href="/assets/js/56.b9e6424d.js"><link rel="prefetch" href="/assets/js/57.b4f774d2.js"><link rel="prefetch" href="/assets/js/6.c5ef4f48.js"><link rel="prefetch" href="/assets/js/7.955a46ff.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5a4296f1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ef76fb7a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Yolo Cloud</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/linG5821" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/linG5821" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/machine/" class="sidebar-heading clickable"><span>机器环境</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/network/" class="sidebar-link">网络编程</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/database/" class="sidebar-heading clickable"><span>数据库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/middleware/" class="sidebar-heading clickable"><span>中间件</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/container/" class="sidebar-heading clickable router-link-active open"><span>容器技术</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/container/docker.html" aria-current="page" class="active sidebar-link">Docker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/container/docker.html#docker安装" class="sidebar-link">Docker安装</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#docker配置" class="sidebar-link">Docker配置</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#特殊命令操作" class="sidebar-link">特殊命令操作</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#dockerfile" class="sidebar-link">Dockerfile</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#docker-swarm" class="sidebar-link">Docker Swarm</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#docker-compose安装" class="sidebar-link">Docker Compose安装</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#docker-stack-使用" class="sidebar-link">Docker Stack 使用</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#常见问题" class="sidebar-link">常见问题</a></li><li class="sidebar-sub-header"><a href="/container/docker.html#一个dockefile示例" class="sidebar-link">一个Dockefile示例</a></li></ul></li><li><a href="/container/kubernetes.html" class="sidebar-link">Kubernetes</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/tool/" class="sidebar-heading clickable"><span>常用工具</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/security/" class="sidebar-heading clickable"><span>安全技术</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java/" class="sidebar-heading clickable"><span>Java</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/go/" class="sidebar-link">Go</a></li><li><a href="/php/" class="sidebar-link">PHP</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/ai/" class="sidebar-heading clickable"><span>人工智能</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="docker安装"><a href="#docker安装" class="header-anchor">#</a> Docker安装</h2> <ol><li><p>添加Docker 安装包的仓库</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils

<span class="token comment"># docker官方仓库</span>
<span class="token function">sudo</span> yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
<span class="token comment"># 阿里云仓库</span>
<span class="token function">sudo</span> yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</code></pre></div></li> <li><p>按照Docker版本排序，安装指定版本</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 按照版本排序</span>
yum list docker-ce --showduplicates<span class="token operator">|</span><span class="token function">sort</span> <span class="token parameter variable">-r</span>

<span class="token comment"># 选择指定版本安装</span>
yum <span class="token function">install</span> docker-ce-19.03.2-3.el7
</code></pre></div></li></ol> <h2 id="docker配置"><a href="#docker配置" class="header-anchor">#</a> Docker配置</h2> <ol><li><p>重启守护进程，但不重启容器(无法在docker swarm集群下使用)</p> <div class="language-shell extra-class"><pre class="language-shell"><code> <span class="token comment"># 修改 /etc/docker/daemon.json</span>
 <span class="token punctuation">{</span> <span class="token string">&quot;live-restore&quot;</span><span class="token builtin class-name">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
 <span class="token comment"># 更新配置</span>
 <span class="token function">kill</span> <span class="token parameter variable">-SIGHUP</span> <span class="token variable"><span class="token variable">$(</span>pidof dockerd<span class="token variable">)</span></span>
 <span class="token comment"># 检查是否配置成功</span>
 <span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> live
 <span class="token comment"># 重启docker 不会重启容器</span>
 systemctl restart <span class="token function">docker</span>
</code></pre></div></li> <li><p>Docker 容器配置重新加载</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> <span class="token function">kill</span> <span class="token parameter variable">-s</span> HUP <span class="token punctuation">{</span>container-name<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="特殊命令操作"><a href="#特殊命令操作" class="header-anchor">#</a> 特殊命令操作</h2> <ol><li><p>抓取容器网络请求包</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 获取容器的进程PID</span>
<span class="token function">docker</span> inspect <span class="token parameter variable">--format</span> <span class="token string">&quot;{{.State.Pid}}&quot;</span> <span class="token variable">${container_id<span class="token operator">/</span>name}</span>
<span class="token comment"># 切换网络命名空间 PS : 退出使用exit 通过ifconfig 对比变化 多次执行需要退出多次</span>
nsenter <span class="token parameter variable">-n</span> <span class="token parameter variable">-t</span> <span class="token variable">${container_id<span class="token operator">/</span>name}</span>
<span class="token comment"># 使用tcpdump抓取网络请求包</span>
<span class="token comment"># 例如: tcpdump tcp -i eth1 port 6379</span>
</code></pre></div></li></ol> <h2 id="dockerfile"><a href="#dockerfile" class="header-anchor">#</a> Dockerfile</h2> <ol><li><p>Dockerfile中 ENTRYPOINT/CMD 指定使用 shell 方式和exec方式时读取环境变量的区别</p> <div class="language-shell extra-class"><pre class="language-shell"><code>shell 方式  只能读取到在 Dockerfile 中设置的环境变量, 无法读取通过-e指定但是没有在dockerfile中的环境变量
<span class="token builtin class-name">exec</span> 方式 不仅能读取 Dockerfile 中的环境变量, 还能读取不存在的通过-e指定的其他环境变量
</code></pre></div></li></ol> <h2 id="docker-swarm"><a href="#docker-swarm" class="header-anchor">#</a> Docker Swarm</h2> <ol><li><p>创建overlay 网络</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> network create <span class="token parameter variable">--attachable</span> <span class="token parameter variable">-d</span> overlay network_name <span class="token parameter variable">--subnet</span><span class="token operator">=</span><span class="token variable">${subnet}</span>
</code></pre></div></li> <li><p>swarm集群需要开放的端口</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># TCP 2377 用于swarm集群</span>
<span class="token comment"># TCP/UDP 端口 4789 覆盖网络流量 容器间可以相互ping通</span>
<span class="token comment"># TCP/UDP 端口 7946 节点间通信(容器网络发现)</span>
iptables <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">2377</span> <span class="token parameter variable">-j</span> ACCEPT
iptables <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">4789</span> <span class="token parameter variable">-j</span> ACCEPT
iptables <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-p</span> udp <span class="token parameter variable">--dport</span> <span class="token number">4789</span> <span class="token parameter variable">-j</span> ACCEPT
iptables <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">7946</span> <span class="token parameter variable">-j</span> ACCEPT
iptables <span class="token parameter variable">-I</span> INPUT <span class="token parameter variable">-p</span> udp <span class="token parameter variable">--dport</span> <span class="token number">7946</span> <span class="token parameter variable">-j</span> ACCEPT

</code></pre></div></li> <li><p>overlay网络创建后,子节点无法从docker-compose 直接使用,可以手动创建一个容器指定该网络后,该网络才会显示在子节点的网络列表中,在无任何引用节点后又会消失</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">docker</span> run <span class="token parameter variable">-it</span> <span class="token parameter variable">-d</span>  <span class="token parameter variable">--network</span> <span class="token variable">${network}</span> busybox
</code></pre></div></li> <li><p>Error response from daemon: Could not attach to network mystack_default : context deadline exceeded</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> <span class="token function">node</span> update <span class="token parameter variable">--availability</span> active nodeId
</code></pre></div></li> <li><p>Swarm Node 标签操作</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 更新 role 可以更换其他键 相同键仅能有一个值</span>
<span class="token function">docker</span> <span class="token function">node</span> update --label-add <span class="token assign-left variable">role</span><span class="token operator">=</span>xxxx <span class="token punctuation">{</span>node<span class="token punctuation">}</span>

<span class="token comment"># 移除 role 为删除的键</span>
<span class="token function">docker</span> <span class="token function">node</span> update --label-rm role <span class="token punctuation">{</span>node<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="docker-compose安装"><a href="#docker-compose安装" class="header-anchor">#</a> Docker Compose安装</h2> <ol><li><p>下载docker-compose 文件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 最新版本请参考 https://docs.docker.com/compose/install/</span>
<span class="token function">sudo</span> <span class="token function">curl</span> <span class="token parameter variable">-L</span> <span class="token string">&quot;https://github.com/docker/compose/releases/download/1.29.2/docker-compose-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-s</span><span class="token variable">)</span></span>-<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token parameter variable">-m</span><span class="token variable">)</span></span>&quot;</span> <span class="token parameter variable">-o</span> /usr/local/bin/docker-compose
</code></pre></div></li> <li><p>修改二进制执行权限</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose
</code></pre></div></li> <li><p>测试安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看是否显示版本信息</span>
<span class="token function">docker-compose</span> <span class="token parameter variable">--version</span>
</code></pre></div></li></ol> <h2 id="docker-stack-使用"><a href="#docker-stack-使用" class="header-anchor">#</a> Docker Stack 使用</h2> <ol><li>部署命令 <code>docker stack deploy -c xxxx.yml {stack_name} --with-registry-auth</code> 当拉取镜像需要权限时需要添加 <code>--with-registry-auth</code></li> <li>部署模式 deploy.mode
<ul><li>部署模式分为 <code>global</code> 和  <code>replicated</code>(默认)</li> <li><code>global</code> 会根据部署策略在每一个节点上都部署一个服务, 没有预先指定数量, 那么每次新增节点服务也会被分配到新的节点</li> <li><code>replicated</code> 可以指定相同服务的数量, 并根据策略分发在符合条件的机器上</li></ul></li> <li>端口发布模式 ports.mode
<ul><li>端口发布模式分为 <code>host</code> 和  <code>ingress</code>(默认)</li> <li><code>host</code> 会把每一个部署了服务的节点的端口都映射出来, 所以当端口发布模式为 <code>host</code> 时 指定 <code>replicas</code> 大于 swarm集群节点数量时只能启动 集群节点数量的服务节点, 因为一个集群节点只能映射一个端口</li> <li><code>ingress</code> 会把swarm 集群内所有节点的端口都映射, 即使这个机器上没有部署该服务</li></ul></li></ol> <h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <ol><li><p>Docker服务安装后无法启动 Error starting daemon: Error initializing network controller: error obtaining controller instance: failed to create NAT chain: Iptables not found</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># docker 需要 iptables进行转发 安装iptables</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> iptables.service
systemctl start iptables.service
systemctl <span class="token builtin class-name">enable</span> iptables.service
</code></pre></div></li> <li><p>Docker swarm 集群强制退出导致 Error response from daemon: rpc error: code = Unknown desc = The swarm does not have a leader. It's possible that too few managers are online. Make sure more than half of the managers are online.</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> swarm init --force-new-cluster
</code></pre></div></li></ol> <h2 id="一个dockefile示例"><a href="#一个dockefile示例" class="header-anchor">#</a> 一个Dockefile示例</h2> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## entrypoint.sh</span>
<span class="token comment">## java17 才支持该参数 -r</span>

<span class="token comment">#!/bin/sh</span>
<span class="token function">nohup</span> jstatd <span class="token variable">${JSTATD_ARGS}</span> <span class="token operator">&gt;</span> jstatd.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
<span class="token function">java</span>  <span class="token variable">${HEAP_OPTS}</span> <span class="token variable">${JAVA_OPTS}</span> <span class="token variable">${GC_OPTS}</span> <span class="token variable">${JMX_OPTS}</span> <span class="token parameter variable">-jar</span> /opt/<span class="token variable">${JAR_FILE}</span>
</code></pre></div><div class="language-dockerfile extra-class"><pre class="language-dockerfile"><code><span class="token instruction"><span class="token keyword">FROM</span> eclipse-temurin:17</span>

<span class="token instruction"><span class="token keyword">ENV</span> RMI_HOSTNAME=<span class="token string">&quot;一个IP&quot;</span></span>
<span class="token instruction"><span class="token keyword">ENV</span> RMI_PORT=29010</span>

<span class="token instruction"><span class="token keyword">ENV</span> HEAP_OPTS=<span class="token string">&quot;-Xms4G -Xmx4G&quot;</span></span>

<span class="token instruction"><span class="token keyword">ENV</span> JAVA_OPTS=<span class="token string">&quot;-Duser.timezone=GMT+08 \
-Djava.security.egd=file:/dev/./urandom \
--add-opens=java.base/sun.net=ALL-UNNAMED \
--add-opens=java.base/java.lang.invoke=ALL-UNNAMED \
-Xlog:gc*=debug:file=./data/log/gc/gc%t.log:utctime,level,tags:filecount=50,filesize=100M&quot;</span></span>

<span class="token instruction"><span class="token keyword">ENV</span> GC_OPTS=<span class="token string">&quot;-XX:+UnlockExperimentalVMOptions \
-XX:+UseG1GC \
-XX:+UseStringDeduplication \
-XX:G1NewSizePercent=20 \
-XX:G1MaxNewSizePercent=40 \
-XX:ConcGCThreads=8&quot;</span></span>

<span class="token instruction"><span class="token keyword">ENV</span> JMX_OPTS=<span class="token string">&quot;-Dcom.sun.management.jmxremote \
-Dcom.sun.management.jmxremote.port=${RMI_PORT} \
-Dcom.sun.management.jmxremote.rmi.port=${RMI_PORT} \
-Dcom.sun.management.jmxremote.authenticate=false \
-Dcom.sun.management.jmxremote.ssl=false \
-Djava.rmi.server.hostname=${RMI_HOSTNAME}&quot;</span></span>


<span class="token instruction"><span class="token keyword">ENV</span> TZ=Asia/Shanghai</span>

<span class="token instruction"><span class="token keyword">RUN</span> ln -snf /usr/share/zoneinfo/<span class="token variable">$TZ</span> /etc/localtime &amp;&amp; <span class="token operator">\</span>
    echo <span class="token variable">$TZ</span> &gt; /etc/timezone &amp;&amp; <span class="token operator">\</span>
    sed -i <span class="token string">'s/archive.ubuntu.com/mirrors.aliyun.com/g'</span> /etc/apt/sources.list &amp;&amp; <span class="token operator">\</span>
    apt update &amp;&amp; apt-get install -y telnet &amp;&amp; <span class="token operator">\</span>
    mkdir -p /opt/data/log/gc</span>

<span class="token instruction"><span class="token keyword">ENV</span> JSTATD_PORT=29011</span>
<span class="token instruction"><span class="token keyword">ENV</span> JSTATD_RMI_PORT=29012</span>

<span class="token instruction"><span class="token keyword">ENV</span> JSTATD_ARGS=<span class="token string">&quot;-J-Djava.security.policy=/opt/jvm/jstatd.all.policy -J-Djava.rmi.server.hostname=${RMI_HOSTNAME} -J-Djava.rmi.server.logCalls=true -p ${JSTATD_PORT} -r ${JSTATD_RMI_PORT}&quot;</span></span>

<span class="token instruction"><span class="token keyword">RUN</span> mkdir -p /opt/jvm &amp;&amp; <span class="token operator">\</span>
    echo <span class="token string">'grant codebase &quot;jrt:/jdk.jstatd&quot; {\n  permission java.security.AllPermission;\n};\n grant codebase &quot;jrt:/jdk.internal.jvmstat&quot; {\n  permission java.security.AllPermission;\n};'</span> &gt; /opt/jvm/jstatd.all.policy</span>

<span class="token instruction"><span class="token keyword">ARG</span> JAR_FILE</span>
<span class="token instruction"><span class="token keyword">ENV</span> JAR_FILE=<span class="token variable">${JAR_FILE}</span></span>

<span class="token instruction"><span class="token keyword">COPY</span> ./entrypoint.sh /opt/entrypoint.sh</span>
<span class="token instruction"><span class="token keyword">COPY</span> target/<span class="token variable">${JAR_FILE}</span> /opt/<span class="token variable">${JAR_FILE}</span></span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> opt</span>

<span class="token instruction"><span class="token keyword">VOLUME</span> /opt/data</span>

<span class="token instruction"><span class="token keyword">EXPOSE</span> <span class="token variable">${RMI_PORT}</span> <span class="token variable">${JSTATD_PORT}</span> <span class="token variable">${JSTATD_RMI_PORT}</span></span>

<span class="token instruction"><span class="token keyword">ENTRYPOINT</span> [<span class="token string">&quot;sh&quot;</span>, <span class="token string">&quot;/opt/entrypoint.sh&quot;</span>]</span>

</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">1/26/2024, 2:01:44 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/middleware/rocketmq.html" class="prev">
        RocketMQ
      </a></span> <span class="next"><a href="/container/kubernetes.html">
        Kubernetes
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8b02bca0.js" defer></script><script src="/assets/js/2.f0a5ede2.js" defer></script><script src="/assets/js/1.b1f9bc46.js" defer></script><script src="/assets/js/26.2fbe0a85.js" defer></script>
  </body>
</html>
