<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>jvm 远程监控 | Yolo Cloud</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/favicon.png">
    <meta name="description" content="Yolo Cloud 记录了我技术成长中学到的各种知识,遇到的各种问题">
    
    <link rel="preload" href="/assets/css/0.styles.ef76fb7a.css" as="style"><link rel="preload" href="/assets/js/app.cc098935.js" as="script"><link rel="preload" href="/assets/js/2.e3a3f2a2.js" as="script"><link rel="preload" href="/assets/js/1.9e095b07.js" as="script"><link rel="preload" href="/assets/js/36.984b860e.js" as="script"><link rel="prefetch" href="/assets/js/10.ca5532e3.js"><link rel="prefetch" href="/assets/js/11.3eb70726.js"><link rel="prefetch" href="/assets/js/12.ea586b3f.js"><link rel="prefetch" href="/assets/js/13.da865689.js"><link rel="prefetch" href="/assets/js/14.0dc3310a.js"><link rel="prefetch" href="/assets/js/15.3ec2ac0e.js"><link rel="prefetch" href="/assets/js/16.f22e6e79.js"><link rel="prefetch" href="/assets/js/17.f6e43693.js"><link rel="prefetch" href="/assets/js/18.7d6f3013.js"><link rel="prefetch" href="/assets/js/19.543cb74c.js"><link rel="prefetch" href="/assets/js/20.71d66c7d.js"><link rel="prefetch" href="/assets/js/21.8abec306.js"><link rel="prefetch" href="/assets/js/22.3524a129.js"><link rel="prefetch" href="/assets/js/23.5555038b.js"><link rel="prefetch" href="/assets/js/24.eb830289.js"><link rel="prefetch" href="/assets/js/25.5f2f66ad.js"><link rel="prefetch" href="/assets/js/26.de135de3.js"><link rel="prefetch" href="/assets/js/27.a6cd77c2.js"><link rel="prefetch" href="/assets/js/28.4ce49356.js"><link rel="prefetch" href="/assets/js/29.609c8337.js"><link rel="prefetch" href="/assets/js/3.cd687dd1.js"><link rel="prefetch" href="/assets/js/30.9c4f60f8.js"><link rel="prefetch" href="/assets/js/31.a50a8381.js"><link rel="prefetch" href="/assets/js/32.fb69fef0.js"><link rel="prefetch" href="/assets/js/33.3c7f8e9a.js"><link rel="prefetch" href="/assets/js/34.3478d196.js"><link rel="prefetch" href="/assets/js/35.74cf6739.js"><link rel="prefetch" href="/assets/js/37.a8f50a47.js"><link rel="prefetch" href="/assets/js/38.60bda7ec.js"><link rel="prefetch" href="/assets/js/39.e81b415f.js"><link rel="prefetch" href="/assets/js/4.c5e770fe.js"><link rel="prefetch" href="/assets/js/40.159dc556.js"><link rel="prefetch" href="/assets/js/41.796f71f2.js"><link rel="prefetch" href="/assets/js/42.25ea701b.js"><link rel="prefetch" href="/assets/js/43.dc20334e.js"><link rel="prefetch" href="/assets/js/44.4b93593f.js"><link rel="prefetch" href="/assets/js/45.6dc074c7.js"><link rel="prefetch" href="/assets/js/46.7974084c.js"><link rel="prefetch" href="/assets/js/47.58351551.js"><link rel="prefetch" href="/assets/js/48.5f28aeb3.js"><link rel="prefetch" href="/assets/js/49.4562d182.js"><link rel="prefetch" href="/assets/js/5.417f2406.js"><link rel="prefetch" href="/assets/js/50.1fb0cc27.js"><link rel="prefetch" href="/assets/js/51.58bd6cac.js"><link rel="prefetch" href="/assets/js/52.2e9c2f26.js"><link rel="prefetch" href="/assets/js/53.248db3e5.js"><link rel="prefetch" href="/assets/js/54.02136a92.js"><link rel="prefetch" href="/assets/js/55.aa10dd82.js"><link rel="prefetch" href="/assets/js/56.b9e6424d.js"><link rel="prefetch" href="/assets/js/57.b4f774d2.js"><link rel="prefetch" href="/assets/js/6.c5ef4f48.js"><link rel="prefetch" href="/assets/js/7.955a46ff.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5a4296f1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.ef76fb7a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Yolo Cloud</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/linG5821" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><a href="https://github.com/linG5821" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/machine/" class="sidebar-heading clickable"><span>机器环境</span> <span class="arrow right"></span></a> <!----></section></li><li><a href="/network/" class="sidebar-link">网络编程</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/database/" class="sidebar-heading clickable"><span>数据库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/middleware/" class="sidebar-heading clickable"><span>中间件</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/container/" class="sidebar-heading clickable"><span>容器技术</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/tool/" class="sidebar-heading clickable"><span>常用工具</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/security/" class="sidebar-heading clickable"><span>安全技术</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/java/" class="sidebar-heading clickable router-link-active open"><span>Java</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/javase.html" class="sidebar-link">JavaSE</a></li><li><a href="/java/jvm.html" aria-current="page" class="active sidebar-link">Java虚拟机</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/java/jvm.html#jvm-远程监控" class="sidebar-link">jvm 远程监控</a></li><li class="sidebar-sub-header"><a href="/java/jvm.html#堆内存划分" class="sidebar-link">堆内存划分</a></li><li class="sidebar-sub-header"><a href="/java/jvm.html#垃圾收集器" class="sidebar-link">垃圾收集器</a></li><li class="sidebar-sub-header"><a href="/java/jvm.html#jvm性能调优-todo" class="sidebar-link">JVM性能调优 TODO</a></li><li class="sidebar-sub-header"><a href="/java/jvm.html#jvm命令行工具" class="sidebar-link">Jvm命令行工具</a></li><li class="sidebar-sub-header"><a href="/java/jvm.html#自行编译jdk" class="sidebar-link">自行编译JDK</a></li></ul></li><li><a href="/java/reactive.html" class="sidebar-link">Java响应式编程</a></li><li><a href="/java/maven.html" class="sidebar-link">Maven</a></li><li><a href="/java/spring.html" class="sidebar-link">Spring</a></li><li><a href="/java/boot&amp;cloud.html" class="sidebar-link">Boot&amp;Cloud</a></li><li><a href="/java/netty.html" class="sidebar-link">Netty</a></li></ul></section></li><li><a href="/go/" class="sidebar-link">Go</a></li><li><a href="/php/" class="sidebar-link">PHP</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/ai/" class="sidebar-heading clickable"><span>人工智能</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="jvm-远程监控"><a href="#jvm-远程监控" class="header-anchor">#</a> jvm 远程监控</h2> <p>本地可以通过 VisualVM 远程可视化的监控 JVM 的指标, 方便排查 JVM 相关的问题, 通过 VisualGC 插件可以可视化的查看 GC 情况</p> <p>服务机部署:</p> <ol><li>开启JMX(用于监控CPU, 内存使用等):</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## 添加程序 JVM 参数</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote.port</span><span class="token operator">=</span><span class="token punctuation">{</span>JMX绑定端口号<span class="token punctuation">}</span> <span class="token punctuation">\</span> <span class="token comment">## jmxremote.port 是JMX 连接使用的端口, jmxremote.rmi.port 默认会使用随机端口, 当服务器上有防火墙时或者使用Docker时, 需要同时放通这两个端口, 他们可以设置为相同, 这样只需要放通一个端口</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote.rmi.port</span><span class="token operator">=</span><span class="token punctuation">{</span>JMX绑定端口号<span class="token punctuation">}</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote.authenticate</span><span class="token operator">=</span>false <span class="token punctuation">\</span>
<span class="token parameter variable">-Dcom.sun.management.jmxremote.ssl</span><span class="token operator">=</span>false <span class="token punctuation">\</span>
<span class="token parameter variable">-Djava.rmi.server.hostname</span><span class="token operator">=</span><span class="token punctuation">{</span>服务器IP<span class="token punctuation">}</span>&quot; <span class="token comment">## 服务器IP是可以被本地机器访问的公网/内网IP</span>

</code></pre></div><ol start="2"><li>开启 jstatd(用于VisualGC)</li></ol> <ul><li><p>配置安全策略</p> <div class="language-shell extra-class"><pre class="language-shell"><code>
<span class="token comment">## 添加 jstatd.all.policy</span>
<span class="token function">vim</span> jstatd.all.policy

<span class="token comment">## java8及以下添加以下内容</span>
grant codeBase <span class="token string">&quot;file:<span class="token variable">${JAVA_HOME}</span>lib/tools.jar&quot;</span> <span class="token punctuation">{</span>
      permission java.security.AllPermission<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">## java9+ 添加以下内容</span>
grant codebase <span class="token string">&quot;jrt:/jdk.jstatd&quot;</span> <span class="token punctuation">{</span>    
  permission java.security.AllPermission<span class="token punctuation">;</span>    
<span class="token punctuation">}</span><span class="token punctuation">;</span>

grant codebase <span class="token string">&quot;jrt:/jdk.internal.jvmstat&quot;</span> <span class="token punctuation">{</span>    
  permission java.security.AllPermission<span class="token punctuation">;</span>    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>运行命令</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment">## java.security.policy 指定创建的策略文件的绝对路径即可</span>
<span class="token comment">## 服务器IP是可以被本地机器访问的公网/内网IP</span>
<span class="token comment">## -p 指定的是jstatd 的连接参数</span>
<span class="token comment">## 除了 -p 指定的端口外还有一个端口是随机的, 在网络受限的环境中(防火墙、Docker等), 如果这个端口无法访问不能正常监控, VisualGC 界面会显示 &quot;不支持的JVM&quot; 内容</span>

<span class="token comment">## jdk 14及以下是无法参数固定该随机端口, 所以正在这种情况下有三种方案, 参考博客: https://blog.csdn.net/Aquester/article/details/84825763, ejstatd 的方案是可以参考的，gdb 方案可能相对需要一些 linux 调试的基础</span>

jstatd -J-Djava.security.policy<span class="token operator">=</span>/opt/jvm/jstatd.all.policy -J-Djava.rmi.server.hostname<span class="token operator">=</span><span class="token punctuation">{</span>服务器IP<span class="token punctuation">}</span> -J-Djava.rmi.server.logCalls<span class="token operator">=</span>true <span class="token parameter variable">-p</span> <span class="token number">19011</span> 

<span class="token comment">## jdk 15+ 支持了一个新的参数 -r 可以指定这个随机端口, 这样在网络受限的环境中可以同时开启-p -r 就可以了, 这两个端口需要指定为不同的</span>
<span class="token operator">!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>https://ling-root-bucket.oss-cn-hangzhou.aliyuncs.com/picgo/20231204182308.png<span class="token punctuation">)</span>

jstatd -J-Djava.security.policy<span class="token operator">=</span>/opt/jvm/jstatd.all.policy -J-Djava.rmi.server.hostname<span class="token operator">=</span><span class="token punctuation">{</span>服务器IP<span class="token punctuation">}</span> -J-Djava.rmi.server.logCalls<span class="token operator">=</span>true <span class="token parameter variable">-p</span> <span class="token number">19011</span> <span class="token parameter variable">-r</span> <span class="token number">19012</span>


</code></pre></div></li></ul> <h2 id="堆内存划分"><a href="#堆内存划分" class="header-anchor">#</a> 堆内存划分</h2> <p><img src="https://ling-root-bucket.oss-cn-hangzhou.aliyuncs.com/picgo/20190107162107114.png" alt="jvm堆划分"></p> <p>由上得知 堆内存={ 新生代, 老年代, 永久代}; 新生代={ Eden 区, Survior 1区, Survior 2区 }</p> <blockquote><p>永久代在JDK1.8中被整个移除, 取而代之的是元空间, 永久代使用的是JVM的堆内存, 而元空间使用的是物联内存, 直接受到本机的物理内存限制</p></blockquote> <div class="spinner" style="background:rgb(66, 185, 131);" data-v-1bbcb91a></div><h2 id="垃圾收集器"><a href="#垃圾收集器" class="header-anchor">#</a> 垃圾收集器</h2> <p><img src="https://ling-root-bucket.oss-cn-hangzhou.aliyuncs.com/picgo/c625baa0-dde6-449e-93df-c3a67f2f430f.jpg" alt=""></p> <p>以上为HotSpot七种垃圾收集器, 相连的代表可以配合使用, 除了 CMS 和 G1 之外，其它垃圾收集器都是以串行的方式执行</p> <ul><li>收集器总结</li></ul> <table><thead><tr><th>收集器</th> <th>串行、并行、并发</th> <th>新生代/老年代</th> <th>算法</th> <th>目标</th> <th>适用场景</th></tr></thead> <tbody><tr><td><strong>Serial</strong></td> <td>串行</td> <td>新生代</td> <td>复制算法</td> <td>响应速度优先</td> <td>单CPU环境下的Client模式</td></tr> <tr><td><strong>Serial Old</strong></td> <td>串行</td> <td>老年代</td> <td>标记-整理</td> <td>响应速度优先</td> <td>单CPU环境下的Client模式,CMS的后备预案</td></tr> <tr><td><strong>ParNew</strong></td> <td>并行</td> <td>新生代</td> <td>复制算法</td> <td>响应速度优先</td> <td>多CPU环境时在Server模式下与CMS配合</td></tr> <tr><td><strong>Parallel Scavenge</strong></td> <td>并行</td> <td>新生代</td> <td>复制算法</td> <td>吞吐量优先</td> <td>在后台运算而不需要太多交互的任务</td></tr> <tr><td><strong>Parallel Old</strong></td> <td>并行</td> <td>老年代</td> <td>标记-整理</td> <td>吞吐量优先</td> <td>在后台运算而不需要太多交互的任务</td></tr> <tr><td><strong>CMS</strong></td> <td>并发</td> <td>老年代</td> <td>标记-清除</td> <td>响应速度优先</td> <td>集中在互联网站或B/S系统服务端的Java应用</td></tr> <tr><td><strong>G1</strong></td> <td>并发</td> <td>新生代+老年代</td> <td>标记-整理+复制算法</td> <td>响应速度优先</td> <td>面向服务端应用,将来替换CMS</td></tr> <tr><td><strong>ZGC</strong></td> <td>全并发(几乎)</td> <td>新生代+老年代</td> <td>标记-复制</td> <td>响应速度优先</td> <td>面向服务端应用,下一代垃圾回收器</td></tr></tbody></table> <ul><li>参数总结</li></ul> <table><thead><tr><th>参数</th> <th>MinorGC</th> <th style="text-align:left;">FullGC</th> <th>描述</th></tr></thead> <tbody><tr><td>-XX:+UseSerialGC</td> <td>Serial收集器串行回收</td> <td style="text-align:left;">Serial Old收集器串行回收</td> <td>该选项可以手动指定Serial收集器+Serial Old收集器组合执行内存回收</td></tr> <tr><td>-XX:+UseParNewGC</td> <td>ParNew收集器并行回收</td> <td style="text-align:left;">Serial Old收集器串行回收</td> <td>该选项可以手动指定ParNew收集器+Serilal Old组合执行内存回收</td></tr> <tr><td>-XX:+UseParallelGC</td> <td>Parallel收集器并行回收</td> <td style="text-align:left;">Serial Old收集器串行回收</td> <td>该选项可以手动指定Parallel收集器+Serial Old收集器组合执行内存回收</td></tr> <tr><td>-XX:+UseParallelOldGC</td> <td>Parallel收集器并行回收</td> <td style="text-align:left;">Parallel Old收集器并行回收</td> <td>该选项可以手动指定Parallel收集器+Parallel Old收集器组合执行内存回收</td></tr> <tr><td>-XX:+UseConcMarkSweepGC</td> <td>ParNew收集器并行回收</td> <td style="text-align:left;">缺省使用CMS收集器并发回收，备用采用Serial Old收集器串行回收</td> <td>该选项可以手动指定ParNew收集器+CMS收集器+Serial Old收集器组合执行内存回收。优先使用ParNew收集器+CMS收集器的组合，当出现ConcurrentMode Fail或者Promotion Failed时，则采用ParNew收集器+Serial Old收集器的组合</td></tr> <tr><td>-XX:+UseConcMarkSweepGC<br>-XX:-UseParNewGC</td> <td>Serial收集器串行回收</td> <td style="text-align:left;">缺省使用CMS收集器并发回收，备用采用Serial Old收集器串行回收</td> <td>该选项可以手动指定ParNew收集器+CMS收集器+Serial Old收集器组合执行内存回收。优先使用ParNew收集器+CMS收集器的组合，当出现ConcurrentMode Fail或者Promotion Failed时，则采用ParNew收集器+Serial Old收集器的组合</td></tr> <tr><td>-XX:+UseG1GC</td> <td>G1收集器并发、并行执行内存回收</td> <td style="text-align:left;">G1收集器并发、并行执行内存回收</td> <td>暂无</td></tr> <tr><td>-XX:+UnlockExperimentalVMOptions -XX:+UseZG</td> <td>ZGC收集器几乎全并发执行内存回收</td> <td style="text-align:left;">ZGC收集器几乎全并发执行内存回收</td> <td>暂无</td></tr></tbody></table> <h2 id="jvm性能调优-todo"><a href="#jvm性能调优-todo" class="header-anchor">#</a> JVM性能调优 TODO</h2> <div class="language- extra-class"><pre class="language-text"><code># java8 以前 应当设置 -XX:PermSize -XX:MaxPermSize
# java8 以后 应当设置 -XX:MaxMetaspaceSize -XX:MetaspaceSize

# 1. Java堆大小设置，Xms和Xmx设置为老年代存活对象的3-4倍，即FullGC之后的老年代内存占用的3-4倍
# 2. 永久代(元空间) PermSize和MaxPermSize / MetaspaceSize和MaxMetaspaceSize 设置为老年代存活对象的1.2-1.5倍。
# 3. 年轻代Xmn的设置为老年代存活对象的1-1.5倍。
# 4. 老年代的内存大小设置为老年代存活对象的2-3倍。

# 假如 jstat -gc 1234

OU 为 905371.7 900M

jvm配置为
-XX:MetaspaceSize=1536M -XX:MaxMetaspaceSize=1536M
-Xms4096m -Xmx4096m

-XX:MetaspaceSize=180M -XX:MaxMetaspaceSize=180M -Xms512m -Xmx512m

</code></pre></div><h2 id="jvm命令行工具"><a href="#jvm命令行工具" class="header-anchor">#</a> Jvm命令行工具</h2> <ol><li>jstat 命令用法</li></ol> <p>命令格式:</p> <div class="language- extra-class"><pre class="language-text"><code>jstat [option] VMID [interval] [count]
</code></pre></div><p>常用参数：</p> <ul><li>option - 选项参数，用于指定用户需要查询的虚拟机信息
<ul><li>-class - 监视类装载、卸载数量、总空间以及类装载所耗费的时间</li> <li>-compiler：显示 JIT 编译的相关信息；</li> <li>-gc：监视 Java 堆状况，包括 Eden 区、两个 survivor 区、老年代、永久代等区的容量、已用空间、GC 时间合计等信息。</li> <li>-gccapacity：显示各个代的容量以及使用情况；</li> <li>-gcmetacapacity：显示 Metaspace 的大小；</li> <li>-gcnew：显示新生代信息；</li> <li>-gcnewcapacity：显示新生代大小和使用情况；</li> <li>-gcold：显示老年代和永久代的信息；</li> <li>-gcoldcapacity：显示老年代的大小；</li> <li>-gcutil：显示垃圾回收统计信息；</li> <li>-gccause：显示垃圾回收的相关信息（通 -gcutil），同时显示最后一次或当前正在发生的垃圾回收的诱因；</li> <li>-printcompilation：输出 JIT 编译的方法信息。</li></ul></li> <li>VMID - 如果是本地虚拟机进程，则 VMID 与 LVMID 是一致的；如果是远程虚拟机进程，那 VMID 的格式应当是：[protocol:][//]lvmid[@hostname[:port]/servername]</li> <li>interval - 查询间隔</li> <li>count - 查询次数</li></ul> <p>统计指标含义:</p> <ul><li><p>类加载统计 <code>jstat -class {vmid}</code></p> <ul><li>Loaded: 加载class的数量</li> <li>Bytes：所占用空间大小</li> <li>Unloaded：未加载数量</li> <li>Bytes: 未加载占用空间</li> <li>Time：时间</li></ul></li> <li><p>编译统计 <code>jstat -compiler {vmid}</code></p> <ul><li>Compiled：编译数量。</li> <li>Failed：失败数量</li> <li>Invalid：不可用数量</li> <li>Time：时间</li> <li>FailedType：失败类型</li> <li>FailedMethod：失败的方法</li></ul></li> <li><p>垃圾回收统计 <code>jstat -gc {vmid}</code></p> <ul><li>S0C：第一个幸存区的大小</li> <li>S1C：第二个幸存区的大小</li> <li>S0U：第一个幸存区的使用大小</li> <li>S1U：第二个幸存区的使用大小</li> <li>EC：伊甸园区的大小</li> <li>EU：伊甸园区的使用大小</li> <li>OC：老年代大小</li> <li>OU：老年代使用大小</li> <li>MC：方法区大小</li> <li>MU：方法区使用大小</li> <li>CCSC: 压缩类空间大小</li> <li>CCSU: 压缩类空间使用大小</li> <li>YGC：年轻代垃圾回收次数</li> <li>YGCT：年轻代垃圾回收消耗时间</li> <li>FGC：老年代垃圾回收次数</li> <li>FGCT：老年代垃圾回收消耗时间</li> <li>GCT：垃圾回收消耗总时间</li></ul></li> <li><p>堆内存统计 <code>jstat -gccapacity {vmid}</code></p> <ul><li>NGCMN：新生代最小容量</li> <li>NGCMX：新生代最大容量</li> <li>NGC：当前新生代容量</li> <li>S0C：第一个幸存区大小</li> <li>S1C：第二个幸存区的大小</li> <li>EC：伊甸园区的大小</li> <li>OGCMN：老年代最小容量</li> <li>OGCMX：老年代最大容量</li> <li>OGC：当前老年代大小</li> <li>OC:当前老年代大小</li> <li>MCMN:最小元数据容量</li> <li>MCMX：最大元数据容量</li> <li>MC：当前元数据空间大小</li> <li>CCSMN：最小压缩类空间大小</li> <li>CCSMX：最大压缩类空间大小</li> <li>CCSC：当前压缩类空间大小</li> <li>YGC：年轻代gc次数</li> <li>FGC：老年代GC次数</li></ul></li> <li><p>新生代垃圾回收统计 <code>jstat -gcnew {vmid}</code></p> <ul><li>S0C：第一个幸存区大小</li> <li>S1C：第二个幸存区的大小</li> <li>S0U：第一个幸存区的使用大小</li> <li>S1U：第二个幸存区的使用大小</li> <li>TT: 对象在新生代存活的次数</li> <li>MTT: 对象在新生代存活的最大次数</li> <li>DSS: 期望的幸存区大小</li> <li>EC：伊甸园区的大小</li> <li>EU：伊甸园区的使用大小</li> <li>YGC：年轻代垃圾回收次数</li> <li>YGCT：年轻代垃圾回收消耗时间</li></ul></li> <li><p>新生代内存统计 <code>jstat -gcnewcapacity {vmid}</code></p> <ul><li>NGCMN：新生代最小容量</li> <li>NGCMX：新生代最大容量</li> <li>NGC：当前新生代容量</li> <li>S0CMX：最大幸存1区大小</li> <li>S0C：当前幸存1区大小</li> <li>S1CMX：最大幸存2区大小</li> <li>S1C：当前幸存2区大小</li> <li>ECMX：最大伊甸园区大小</li> <li>EC：当前伊甸园区大小</li> <li>YGC：年轻代垃圾回收次数</li> <li>FGC：老年代回收次数</li></ul></li> <li><p>老年代垃圾回收统计 <code>jstat -gcold {vmid}</code></p> <ul><li>MC：方法区大小</li> <li>MU：方法区使用大小</li> <li>CCSC:压缩类空间大小</li> <li>CCSU:压缩类空间使用大小</li> <li>OC：老年代大小</li> <li>OU：老年代使用大小</li> <li>YGC：年轻代垃圾回收次数</li> <li>FGC：老年代垃圾回收次数</li> <li>FGCT：老年代垃圾回收消耗时间</li> <li>GCT：垃圾回收消耗总时间</li></ul></li> <li><p>老年代内存统计 <code>jstat -gcoldcapacity {vmid}</code></p> <ul><li>OGCMN：老年代最小容量</li> <li>OGCMX：老年代最大容量</li> <li>OGC：当前老年代大小</li> <li>OC：老年代大小</li> <li>YGC：年轻代垃圾回收次数</li> <li>FGC：老年代垃圾回收次数</li> <li>FGCT：老年代垃圾回收消耗时间</li> <li>GCT：垃圾回收消耗总时间</li></ul></li> <li><p>元数据空间统计 <code>jstat -gcmetacapacity {vmid}</code></p> <ul><li>MCMN: 最小元数据容量</li> <li>MCMX：最大元数据容量</li> <li>MC：当前元数据空间大小</li> <li>CCSMN：最小压缩类空间大小</li> <li>CCSMX：最大压缩类空间大小</li> <li>CCSC：当前压缩类空间大小</li> <li>YGC：年轻代垃圾回收次数</li> <li>FGC：老年代垃圾回收次数</li> <li>FGCT：老年代垃圾回收消耗时间</li> <li>GCT：垃圾回收消耗总时间</li></ul></li> <li><p>垃圾回收总览 <code>jstat -gcutil {vmid}</code></p> <ul><li>S0：幸存1区当前使用比例</li> <li>S1：幸存2区当前使用比例</li> <li>E：伊甸园区使用比例</li> <li>O：老年代使用比例</li> <li>M：元数据区使用比例</li> <li>CCS：压缩使用比例</li> <li>YGC：年轻代垃圾回收次数</li> <li>FGC：老年代垃圾回收次数</li> <li>FGCT：老年代垃圾回收消耗时间</li> <li>GCT：垃圾回收消耗总时间</li></ul></li></ul> <ol start="2"><li>jmap 命令用法</li></ol> <p>命令格式:</p> <div class="language-shell extra-class"><pre class="language-shell"><code>jmap <span class="token punctuation">[</span>option<span class="token punctuation">]</span> pid
</code></pre></div><p>option 选项参数：</p> <ul><li>-dump - 生成堆转储快照。-dump:live 只保存堆中的存活对象。</li> <li>-finalizerinfo - 显示在 F-Queue 队列等待执行 finalizer 方法的对象</li> <li>-heap - 显示 Java 堆详细信息。</li> <li>-histo - 显示堆中对象的统计信息，包括类、实例数量、合计容量。-histo:live 只统计堆中的存活对象。</li> <li>-permstat - to print permanent generation statistics</li> <li>-F - 当-dump 没有响应时，强制生成 dump 快照</li></ul> <p>使用示例:</p> <ul><li><p>生成 heapdump 快照</p> <div class="language-shell extra-class"><pre class="language-shell"><code>jmap -dump:live,format<span class="token operator">=</span>b,file<span class="token operator">=</span>dump.hprof <span class="token punctuation">{</span>vmid<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>查看实例最多的类</p> <div class="language-shell extra-class"><pre class="language-shell"><code>jmap <span class="token parameter variable">-histo</span> <span class="token punctuation">{</span>vmid<span class="token punctuation">}</span> <span class="token operator">|</span> <span class="token function">head</span> <span class="token parameter variable">-n</span> <span class="token punctuation">{</span>num<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h2 id="自行编译jdk"><a href="#自行编译jdk" class="header-anchor">#</a> 自行编译JDK</h2> <ol><li><p>编译参数设置</p> <div class="language-ini extra-class"><pre class="language-ini"><code><span class="token key attr-name">export LANG</span><span class="token punctuation">=</span><span class="token value attr-value">C</span>
<span class="token key attr-name">export ALT_BOOTDIR</span><span class="token punctuation">=</span><span class="token value attr-value">/usr/share/java</span>
<span class="token key attr-name">export ALLOW_DOWNLOADS</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">export HOTSPOT_BUILD_JOBS</span><span class="token punctuation">=</span><span class="token value attr-value">8</span>
<span class="token key attr-name">export ALT_PARALLEL_COMPILE_JOBS</span><span class="token punctuation">=</span><span class="token value attr-value">8</span>
<span class="token key attr-name">export SKIP_COMPARE_IMAGES</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># 使用预编译头文件 编译加快</span>
<span class="token key attr-name">export USE_PRECOMPILED_HEADER</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment"># 要编译的内容</span>
<span class="token key attr-name">export BUILD_LANGTOOLS</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#export BUILD_JAXP=false</span>
<span class="token comment">#export BUILD_JAXWS=false</span>
<span class="token comment">#export BUILD_CORBA=false</span>
<span class="token key attr-name">export BUILD_HOTSPOT</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token key attr-name">export BUILD_JDK</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#要编译的版本</span>
<span class="token comment">#export SKIP_DEBUG_BUILD=false</span>
<span class="token comment">#export SKIP_FASTDEBUG_BUILD=true</span>
<span class="token comment">#export DEBUG_NAME=debug</span>
<span class="token comment">#设置为false可以避开javaws和浏览器Java插件的build</span>
<span class="token key attr-name">export BUILD_DEPLOY</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token comment">#设置为false不会build出安装包 安装包中有一些奇怪的依赖</span>
<span class="token key attr-name">export BUILD_INSTALL</span><span class="token punctuation">=</span><span class="token value attr-value">false</span>
<span class="token key attr-name">export ALT_OUTPUTDIR</span><span class="token punctuation">=</span><span class="token value attr-value">/home/ling/jdk/build</span>
<span class="token key attr-name">export DEBUG_BINARIES</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#设置HotSpot编译为64位版本</span>
<span class="token key attr-name">export LP64</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>

./configure --enable-debug 创建编译配置 不指定参数构建为release版本
</code></pre></div></li> <li><p>编译成功的提示</p> <div class="language-shell extra-class"><pre class="language-shell"><code>----- Build <span class="token builtin class-name">times</span> -------
Start <span class="token number">2020</span>-03-14 03:31:24
End   <span class="token number">2020</span>-03-14 03:44:35
00:00:48 corba
00:05:41 hotspot
00:00:43 jaxp
00:01:11 jaxws
00:04:46 jdk
00:00:01 langtools
00:13:11 TOTAL
-------------------------
Finished building OpenJDK <span class="token keyword">for</span> target <span class="token string">'default'</span>

WARNING: You have the following ALT_ variables set:
<span class="token assign-left variable">ALT_PARALLEL_COMPILE_JOBS</span><span class="token operator">=</span><span class="token number">8</span> <span class="token assign-left variable">ALT_BOOTDIR</span><span class="token operator">=</span>/usr/share/java <span class="token assign-left variable">ALT_OUTPUTDIR</span><span class="token operator">=</span>/home/ling/jdk/build
ALT_ variables are deprecated and will be ignored. Please clean your environment.


ling@aidong:~/jdk$ /home/ling/jdk/build/linux-x86_64-normal-server-fastdebug/jdk/bin/javac ./HelloWorld.java
ling@aidong:~/jdk$ <span class="token function">ls</span>
ASSEMBLY_EXCEPTION  HelloWorld.java  Makefile  README-builds.html  build   configure  get_source.sh  jaxp   jdk        <span class="token function">make</span>     <span class="token builtin class-name">test</span>
HelloWorld.class    LICENSE          README    THIRD_PARTY_README  common  corba      hotspot        jaxws  langtools  nashorn
ling@aidong:~/jdk$ <span class="token function">java</span> HelloWorld
HelloWorld openjdk
</code></pre></div></li> <li><p>运行虚拟机</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># 添加环境变量</span>
<span class="token assign-left variable">LD_LIBRARY_PATH</span><span class="token operator">=</span>.:<span class="token variable">${JAVA_HOME}</span>/jre/lib/amd64/native_threads:<span class="token variable">${JAVA_HOME}</span>/jre/lib/amd64
</code></pre></div></li> <li><p>编译错误汇总</p> <ul><li><p>ubuntu内核版本过高</p> <div class="language-shell extra-class"><pre class="language-shell"><code>  *** This OS is not supported: Linux aidong <span class="token number">4.4</span>.0-18362-Microsoft <span class="token comment">#476-Microsoft Fri Nov 01 16:53:00 PST 2019 x86_64 x86_64 x86_64 GNU/Linux</span>
  /home/ling/jdk/hotspot/make/linux/Makefile:234: recipe <span class="token keyword">for</span> target <span class="token string">'check_os_version'</span> failed
  make<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>check_os_version<span class="token punctuation">]</span> Error <span class="token number">1</span>
  make<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>linux_amd64_compiler2/debug<span class="token punctuation">]</span> Error <span class="token number">2</span>
  /home/ling/jdk/hotspot/make/linux/Makefile:255: recipe <span class="token keyword">for</span> target <span class="token string">'linux_amd64_compiler2/debug'</span> failed
  Makefile:216: recipe <span class="token keyword">for</span> target <span class="token string">'generic_build2'</span> failed
  make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>generic_build2<span class="token punctuation">]</span> Error <span class="token number">2</span>
  Makefile:167: recipe <span class="token keyword">for</span> target <span class="token string">'fastdebug'</span> failed
  make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>fastdebug<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>/home/ling/jdk/build/linux-x86_64-normal-server-fastdebug/hotspot/_hotspot.timestamp<span class="token punctuation">]</span> Error <span class="token number">2</span>
  HotspotWrapper.gmk:44: recipe <span class="token keyword">for</span> target <span class="token string">'/home/ling/jdk/build/linux-x86_64-normal-server-fastdebug/hotspot/_hotspot.timestamp'</span> failed
  /home/ling/jdk//make/Main.gmk:108: recipe <span class="token keyword">for</span> target <span class="token string">'hotspot-only'</span> failed
  make: *** <span class="token punctuation">[</span>hotspot-only<span class="token punctuation">]</span> Error <span class="token number">2</span>

  <span class="token comment"># 解决方案:vim make/linux/Makefile</span>
  :/SUPPORTED_OS_VERSION 搜索改关键字
  - SUPPORTED_OS_VERSION <span class="token operator">=</span> <span class="token number">2.4</span>% <span class="token number">2.5</span>% <span class="token number">2.6</span>% <span class="token number">3</span>%
  + SUPPORTED_OS_VERSION <span class="token operator">=</span> <span class="token number">2.4</span>% <span class="token number">2.5</span>% <span class="token number">2.6</span>% <span class="token number">4</span>%

  <span class="token comment"># 解决方案:vim xxx/hotspot/make/linux/Makefile 67行</span>
</code></pre></div></li> <li><p>make版本的问题，4.0以后make-I和-j选项混乱</p> <div class="language-shell extra-class"><pre class="language-shell"><code>  /usr/bin/make: invalid option -- <span class="token string">'/'</span>
  /usr/bin/make: invalid option -- <span class="token string">'a'</span>
  /usr/bin/make: invalid option -- <span class="token string">'/'</span>
  /usr/bin/make: invalid option -- <span class="token string">'c'</span>
  Usage: <span class="token function">make</span> <span class="token punctuation">[</span>options<span class="token punctuation">]</span> <span class="token punctuation">[</span>target<span class="token punctuation">]</span> <span class="token punctuation">..</span>.
  Options:
  -b, <span class="token parameter variable">-m</span>                      Ignored <span class="token keyword">for</span> compatibility.
  -B, --always-make           Unconditionally <span class="token function">make</span> all targets.
  <span class="token parameter variable">-C</span> DIRECTORY, <span class="token parameter variable">--directory</span><span class="token operator">=</span>DIRECTORY
                              Change to DIRECTORY before doing anything.
  <span class="token parameter variable">-d</span>                          Print lots of debugging information.
  --debug<span class="token punctuation">[</span><span class="token operator">=</span>FLAGS<span class="token punctuation">]</span>             Print various types of debugging information.
  -e, --environment-overrides
                              Environment variables override makefiles.
  <span class="token parameter variable">--eval</span><span class="token operator">=</span>STRING               Evaluate STRING as a makefile statement.
  <span class="token parameter variable">-f</span> FILE, <span class="token parameter variable">--file</span><span class="token operator">=</span>FILE, <span class="token parameter variable">--makefile</span><span class="token operator">=</span>FILE
                              Read FILE as a makefile.
  -h, <span class="token parameter variable">--help</span>                  Print this message and exit.
  -i, --ignore-errors         Ignore errors from recipes.
  <span class="token parameter variable">-I</span> DIRECTORY, --include-dir<span class="token operator">=</span>DIRECTORY
                              Search DIRECTORY <span class="token keyword">for</span> included makefiles.
  <span class="token parameter variable">-j</span> <span class="token punctuation">[</span>N<span class="token punctuation">]</span>, --jobs<span class="token punctuation">[</span><span class="token operator">=</span>N<span class="token punctuation">]</span>          Allow N <span class="token function">jobs</span> at once<span class="token punctuation">;</span> infinite <span class="token function">jobs</span> with no arg.
  -k, --keep-going            Keep going when some targets can<span class="token string">'t be made.
  -l [N], --load-average[=N], --max-load[=N]
                              Don'</span>t start multiple <span class="token function">jobs</span> unless load is below N.
  -L, --check-symlink-times   Use the latest mtime between symlinks and target.
  -n, --just-print, --dry-run, <span class="token parameter variable">--recon</span>
                              Don<span class="token string">'t actually run any recipe; just print them.
  -o FILE, --old-file=FILE, --assume-old=FILE
                              Consider FILE to be very old and don'</span>t remake it.
  -O<span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span>, --output-sync<span class="token punctuation">[</span><span class="token operator">=</span>TYPE<span class="token punctuation">]</span>
                              Synchronize output of parallel <span class="token function">jobs</span> by TYPE.
  -p, --print-data-base       Print <span class="token function">make</span><span class="token string">'s internal database.
  -q, --question              Run no recipe; exit status says if up to date.
  -r, --no-builtin-rules      Disable the built-in implicit rules.
  -R, --no-builtin-variables  Disable the built-in variable settings.
  -s, --silent, --quiet       Don'</span>t <span class="token builtin class-name">echo</span> recipes.
  -S, --no-keep-going, <span class="token parameter variable">--stop</span>
                              Turns off -k.
  -t, <span class="token parameter variable">--touch</span>                 Touch targets instead of remaking them.
  <span class="token parameter variable">--trace</span>                     Print tracing information.
  -v, <span class="token parameter variable">--version</span>               Print the version number of <span class="token function">make</span> and exit.
  -w, --print-directory       Print the current directory.
  --no-print-directory        Turn off -w, even <span class="token keyword">if</span> it was turned on implicitly.
  <span class="token parameter variable">-W</span> FILE, --what-if<span class="token operator">=</span>FILE, --new-file<span class="token operator">=</span>FILE, --assume-new<span class="token operator">=</span>FILE
                              Consider FILE to be infinitely new.
  --warn-undefined-variables  Warn when an undefined variable is referenced.

  This program built <span class="token keyword">for</span> x86_64-pc-linux-gnu
  Report bugs to <span class="token operator">&lt;</span>bug-make@gnu.org<span class="token operator">&gt;</span>
  make<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>ad_stuff<span class="token punctuation">]</span> Error <span class="token number">2</span>
  /home/ling/jdk/hotspot/make/linux/makefiles/top.make:91: recipe <span class="token keyword">for</span> target <span class="token string">'ad_stuff'</span> failed
  /home/ling/jdk/hotspot/make/linux/Makefile:289: recipe <span class="token keyword">for</span> target <span class="token string">'fastdebug'</span> failed
  make<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>fastdebug<span class="token punctuation">]</span> Error <span class="token number">2</span>
  Makefile:216: recipe <span class="token keyword">for</span> target <span class="token string">'generic_build2'</span> failed
  make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>generic_build2<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>fastdebug<span class="token punctuation">]</span> Error <span class="token number">2</span>
  Makefile:167: recipe <span class="token keyword">for</span> target <span class="token string">'fastdebug'</span> failed
  HotspotWrapper.gmk:44: recipe <span class="token keyword">for</span> target <span class="token string">'/home/ling/jdk/build/linux-x86_64-normal-server-fastdebug/hotspot/_hotspot.timestamp'</span> failed
  make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>/home/ling/jdk/build/linux-x86_64-normal-server-fastdebug/hotspot/_hotspot.timestamp<span class="token punctuation">]</span> Error <span class="token number">2</span>
  /home/ling/jdk//make/Main.gmk:108: recipe <span class="token keyword">for</span> target <span class="token string">'hotspot-only'</span> failed
  make: *** <span class="token punctuation">[</span>hotspot-only<span class="token punctuation">]</span> Error <span class="token number">2</span>

  <span class="token comment"># 解决方案一: 降级make4.0以下(未测试)</span>
  
  <span class="token comment"># 解决方案二:</span>
  <span class="token function">vim</span> xxx/hotspot/make/linux/makefiles/adjust-mflags.sh
  - s/ -<span class="token punctuation">\</span><span class="token punctuation">(</span><span class="token punctuation">[</span>^     <span class="token punctuation">]</span><span class="token punctuation">[</span>^     <span class="token punctuation">]</span>*<span class="token punctuation">\</span><span class="token punctuation">)</span>j/ -<span class="token punctuation">\</span><span class="token number">1</span> -j/
  + s/ -<span class="token punctuation">\</span><span class="token punctuation">(</span><span class="token punctuation">[</span>^     I<span class="token punctuation">]</span><span class="token punctuation">[</span>^     <span class="token punctuation">]</span>*<span class="token punctuation">\</span><span class="token punctuation">)</span>j/ -<span class="token punctuation">\</span><span class="token number">1</span> -j/
</code></pre></div></li> <li><p>gcc/g++ 版本过高</p> <div class="language-shell extra-class"><pre class="language-shell"><code>  In <span class="token function">file</span> included from /home/ling/jdk/hotspot/src/share/vm/memory/sharedHeap.hpp:29:0,
          from /home/ling/jdk/hotspot/src/share/vm/gc_implementation/parallelScavenge/psParallelCompact.hpp:34,
          from /home/ling/jdk/hotspot/src/share/vm/gc_implementation/shared/markSweep.inline.hpp:33,
          from /home/ling/jdk/hotspot/src/share/vm/oops/oop.inline.hpp:29,
          from /home/ling/jdk/hotspot/src/share/vm/classfile/classFileParser.hpp:30,
          from /home/ling/jdk/hotspot/src/share/vm/classfile/classLoader.hpp:28,
          from /home/ling/jdk/hotspot/src/share/vm/classfile/systemDictionary.hpp:29,
          from /home/ling/jdk/hotspot/src/share/vm/ci/ciEnv.hpp:30,
          from /home/ling/jdk/hotspot/src/share/vm/ci/ciUtilities.hpp:28,
          from /home/ling/jdk/hotspot/src/share/vm/ci/ciNullObject.hpp:30,
          from /home/ling/jdk/hotspot/src/share/vm/ci/ciConstant.hpp:29,
          from /home/ling/jdk/hotspot/src/share/vm/ci/ciArray.hpp:29,
          from /home/ling/jdk/hotspot/src/share/vm/precompiled/precompiled.hpp:33:
  /home/ling/jdk/hotspot/src/share/vm/memory/generation.hpp:421:17: error: invalid suffix on literal<span class="token punctuation">;</span> C++11 requires a space between literal and string macro <span class="token punctuation">[</span>-Werror<span class="token operator">=</span>literal-suffix<span class="token punctuation">]</span>
          warning<span class="token punctuation">(</span><span class="token string">&quot;time warp: &quot;</span>INT64_FORMAT<span class="token string">&quot; to &quot;</span>INT64_FORMAT, _time_of_last_gc, now<span class="token punctuation">)</span><span class="token punctuation">;</span>
              ^
  <span class="token comment"># 解决方案</span>
  <span class="token comment"># 这里出现问题的原因是ubuntu版本过高,18.04默认的gcc/g++版本为7.0</span>
  <span class="token comment"># 执行降级操作</span>
  <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc-4.8
  <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> g++-4.8
  <span class="token function">sudo</span> update-alternatives <span class="token parameter variable">--install</span> /usr/bin/gcc gcc /usr/bin/gcc-4.8 <span class="token number">100</span>
  <span class="token function">sudo</span> update-alternatives <span class="token parameter variable">--install</span> /usr/bin/g++ g++ /usr/bin/g++-4.8 <span class="token number">100</span>
  降级操作后需要重新执行./configure --enable-debug 否则版本即使gcc/g++ --version变了还是会报错
  <span class="token function">make</span>  <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token variable">$ALT_OUTPUTDIR</span>/build.log
</code></pre></div></li> <li><p>make错误</p> <div class="language-shell extra-class"><pre class="language-shell"><code>  In <span class="token function">file</span> included from /home/ling/jdk/hotspot/src/share/vm/utilities/histogram.hpp:32:0,
          from /home/ling/jdk/hotspot/src/share/vm/runtime/mutex.hpp:30,
          from /home/ling/jdk/hotspot/src/share/vm/classfile/classLoaderData.hpp:32,
          from /home/ling/jdk/hotspot/src/share/vm/oops/typeArrayKlass.hpp:28,
          from /home/ling/jdk/hotspot/src/share/vm/oops/typeArrayOop.hpp:29,
          from /home/ling/jdk/hotspot/src/share/vm/oops/constantPool.hpp:32,
          from /home/ling/jdk/hotspot/src/share/vm/oops/method.hpp:33,
          from /home/ling/jdk/hotspot/src/share/vm/runtime/frame.hpp:28,
          from /home/ling/jdk/hotspot/src/share/vm/code/codeBlob.hpp:30,
          from /home/ling/jdk/hotspot/src/share/vm/code/codeCache.hpp:28,
          from /home/ling/jdk/hotspot/src/cpu/x86/vm/assembler_x86.inline.hpp:30,
          from /home/ling/jdk/hotspot/src/share/vm/asm/assembler.inline.hpp:31,
          from /home/ling/jdk/hotspot/src/share/vm/precompiled/precompiled.hpp:30:
  /home/ling/jdk/hotspot/src/os/linux/vm/os_linux.inline.hpp: In static member <span class="token keyword">function</span> <span class="token string">'static dirent* os::readdir(DIR*, dirent*)'</span><span class="token builtin class-name">:</span>
  /home/ling/jdk/hotspot/src/os/linux/vm/os_linux.inline.hpp:142:18: error: <span class="token string">'int readdir_r(DIR*, dirent*, dirent**)'</span> is deprecated <span class="token punctuation">(</span>declared at /usr/include/dirent.h:183<span class="token punctuation">)</span> <span class="token punctuation">[</span>-Werror<span class="token operator">=</span>deprecated-declarations<span class="token punctuation">]</span>
  <span class="token keyword">if</span><span class="token variable"><span class="token punctuation">((</span>status <span class="token operator">=</span> <span class="token operator">:</span><span class="token operator">:</span>readdir_r<span class="token punctuation">(</span>dirp<span class="token punctuation">,</span> dbuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">))</span></span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  ^
  /home/ling/jdk/hotspot/src/os/linux/vm/os_linux.inline.hpp:142:42: error: <span class="token string">'int readdir_r(DIR*, dirent*, dirent**)'</span> is deprecated <span class="token punctuation">(</span>declared at /usr/include/dirent.h:183<span class="token punctuation">)</span> <span class="token punctuation">[</span>-Werror<span class="token operator">=</span>deprecated-declarations<span class="token punctuation">]</span>
  <span class="token keyword">if</span><span class="token variable"><span class="token punctuation">((</span>status <span class="token operator">=</span> <span class="token operator">:</span><span class="token operator">:</span>readdir_r<span class="token punctuation">(</span>dirp<span class="token punctuation">,</span> dbuf<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">))</span></span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                          ^
  cc1plus: all warnings being treated as errors
  /home/ling/jdk/hotspot/make/linux/makefiles/vm.make:295: recipe <span class="token keyword">for</span> target <span class="token string">'precompiled.hpp.gch'</span> failed
  make<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>precompiled.hpp.gch<span class="token punctuation">]</span> Error <span class="token number">1</span>
  /home/ling/jdk/hotspot/make/linux/makefiles/top.make:119: recipe <span class="token keyword">for</span> target <span class="token string">'the_vm'</span> failed
  make<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>the_vm<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>fastdebug<span class="token punctuation">]</span> Error <span class="token number">2</span>
  /home/ling/jdk/hotspot/make/linux/Makefile:289: recipe <span class="token keyword">for</span> target <span class="token string">'fastdebug'</span> failed
  Makefile:216: recipe <span class="token keyword">for</span> target <span class="token string">'generic_build2'</span> failed
  make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>generic_build2<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>fastdebug<span class="token punctuation">]</span> Error <span class="token number">2</span>
  Makefile:167: recipe <span class="token keyword">for</span> target <span class="token string">'fastdebug'</span> failed
  HotspotWrapper.gmk:44: recipe <span class="token keyword">for</span> target <span class="token string">'/home/ling/jdk/build/linux-x86_64-normal-server-fastdebug/hotspot/_hotspot.timestamp'</span> failed
  make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>/home/ling/jdk/build/linux-x86_64-normal-server-fastdebug/hotspot/_hotspot.timestamp<span class="token punctuation">]</span> Error <span class="token number">2</span>
  /home/ling/jdk//make/Main.gmk:108: recipe <span class="token keyword">for</span> target <span class="token string">'hotspot-only'</span> failed
  make: *** <span class="token punctuation">[</span>hotspot-only<span class="token punctuation">]</span> Error <span class="token number">2</span>
  
  <span class="token comment"># 解决方案:</span>
  <span class="token function">vim</span> xxx/hotspot/make/linux/makefiles/gcc.make
  注释 WARNINGS_ARE_ERRORS <span class="token operator">=</span> <span class="token parameter variable">-Werror</span>
  或者 WARNINGS_ARE_ERRORS <span class="token operator">=</span> -Wno-all  
  相关Warning都可以通过这个关闭
</code></pre></div></li> <li><p>单独编译JAVA虚拟机错误check_j2se_version版本不通过</p> <div class="language-shell extra-class"><pre class="language-shell"><code>  /usr/share/java/bin/javap javax.xml.transform.TransformerFactory <span class="token operator">&gt;</span> /dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
  <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-ne</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span> <span class="token punctuation">\</span>
  /usr/share/java/bin/java -version<span class="token punctuation">;</span> <span class="token punctuation">\</span>
  <span class="token builtin class-name">echo</span> <span class="token string">&quot;*** An XSLT processor (J2SE 1.4.x or newer) is required&quot;</span> <span class="token punctuation">\</span>
  <span class="token string">&quot;to bootstrap this build&quot;</span> <span class="token operator"><span class="token file-descriptor important">1</span>&gt;</span><span class="token file-descriptor important">&amp;2</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
  <span class="token builtin class-name">exit</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">\</span>
  <span class="token keyword">fi</span>
  /bin/sh: <span class="token number">3</span>: /usr/share/java/bin/java: not found
  *** An XSLT processor <span class="token punctuation">(</span>J2SE <span class="token number">1.4</span>.x or newer<span class="token punctuation">)</span> is required to bootstrap this build
  /home/ling/jdk/hotspot/make/linux/Makefile:241: recipe <span class="token keyword">for</span> target <span class="token string">'check_j2se_version'</span> failed
  make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>check_j2se_version<span class="token punctuation">]</span> Error <span class="token number">1</span>
  make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/ling/jdk/build'</span>
  /home/ling/jdk/hotspot/make/linux/Makefile:255: recipe <span class="token keyword">for</span> target <span class="token string">'linux_i486_compiler2/debug'</span> failed
  make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>linux_i486_compiler2/debug<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/ling/jdk/build'</span>
  Makefile:216: recipe <span class="token keyword">for</span> target <span class="token string">'generic_build2'</span> failed
  make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>generic_build2<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/ling/jdk/hotspot/make'</span>
  Makefile:167: recipe <span class="token keyword">for</span> target <span class="token string">'product'</span> failed
  make: *** <span class="token punctuation">[</span>product<span class="token punctuation">]</span> Error <span class="token number">2</span>
  
  <span class="token comment"># 解决方案:</span>
  ALT_BOOTDIR需要配置正确的jdk路径
  apt-get安装的java路径默认为 /usr/lib/jvm/java-8-openjdk-amd64/bin
</code></pre></div></li> <li><p>单独构建虚拟机报错:默认构建32版本的HotSpot 未安装32位lib是报错</p> <div class="language-shell extra-class"><pre class="language-shell"><code>In <span class="token function">file</span> included from /home/ling/jdk/hotspot/src/share/vm/prims/jni.h:39:0,
              from /home/ling/jdk/hotspot/src/share/vm/prims/jvm.h:28,
              from /home/ling/jdk/hotspot/src/share/vm/utilities/debug.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/runtime/globals.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/memory/allocation.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/memory/iterator.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/memory/genOopClosures.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/oops/klass.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/runtime/handles.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/memory/universe.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/code/oopRecorder.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/asm/codeBuffer.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/asm/assembler.hpp:28,
              from /home/ling/jdk/hotspot/src/share/vm/precompiled/precompiled.hpp:29:
  /usr/include/stdio.h:27:36: fatal error: bits/libc-header-start.h: No such <span class="token function">file</span> or directory
  <span class="token comment">#include &lt;bits/libc-header-start.h&gt;</span>
                                      ^
  compilation terminated.
  /home/ling/jdk/hotspot/make/linux/makefiles/vm.make:295: recipe <span class="token keyword">for</span> target <span class="token string">'precompiled.hpp.gch'</span> failed
  make<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>precompiled.hpp.gch<span class="token punctuation">]</span> Error <span class="token number">1</span>
  make<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/ling/jdk/build/linux_i486_compiler2/product'</span>
  /home/ling/jdk/hotspot/make/linux/makefiles/top.make:119: recipe <span class="token keyword">for</span> target <span class="token string">'the_vm'</span> failed
  make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>the_vm<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/ling/jdk/build/linux_i486_compiler2/product'</span>
  /home/ling/jdk/hotspot/make/linux/Makefile:289: recipe <span class="token keyword">for</span> target <span class="token string">'product'</span> failed
  make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>product<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/ling/jdk/build'</span>
  Makefile:216: recipe <span class="token keyword">for</span> target <span class="token string">'generic_build2'</span> failed
  make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>generic_build2<span class="token punctuation">]</span> Error <span class="token number">2</span>
  make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/ling/jdk/hotspot/make'</span>
  Makefile:167: recipe <span class="token keyword">for</span> target <span class="token string">'product'</span> failed
  make: *** <span class="token punctuation">[</span>product<span class="token punctuation">]</span> Error <span class="token number">2</span>

  <span class="token comment"># 解决方式一:</span>
  <span class="token function">apt-get</span> <span class="token function">install</span> gcc-multilib 这样构建的是32位版本
  <span class="token comment"># 解决方式二:</span>
  <span class="token builtin class-name">export</span> <span class="token assign-left variable">LP64</span><span class="token operator">=</span><span class="token number">1</span>
</code></pre></div></li></ul></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">12/4/2023, 10:25:37 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/java/javase.html" class="prev">
        JavaSE
      </a></span> <span class="next"><a href="/java/reactive.html">
        Java响应式编程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.cc098935.js" defer></script><script src="/assets/js/2.e3a3f2a2.js" defer></script><script src="/assets/js/1.9e095b07.js" defer></script><script src="/assets/js/36.984b860e.js" defer></script>
  </body>
</html>
